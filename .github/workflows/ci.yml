# CI: lint, type-check, unit tests, and Playwright smoke E2E.
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: memoon_card_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d memoon_card_db"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      CI: true
      # Backend config validation (required if any test loads env)
      NODE_ENV: test
      POSTGRES_HOST: localhost
      POSTGRES_PORT: "5432"
      POSTGRES_DB: memoon_card_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      JWT_SECRET: ci-secret-minimum-32-characters-long
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"

      - name: Enable Corepack and Yarn
        run: corepack enable && corepack prepare yarn@4.12.0 --activate

      - name: Install dependencies
        run: yarn install --immutable

      - name: Audit dependencies
        run: yarn npm audit --all --audit-level=high
        continue-on-error: true

      - name: Build Liquibase image
        run: docker build -f migrations/Dockerfile.liquibase -t memoon-liquibase migrations

      - name: Migration smoke (Liquibase update)
        run: docker run --rm --network host -v "$(pwd)/migrations:/liquibase/changelog" -e LIQUIBASE_COMMAND_URL=jdbc:postgresql://localhost:5432/memoon_card_db -e LIQUIBASE_COMMAND_USERNAME=postgres -e LIQUIBASE_COMMAND_PASSWORD=postgres -e LIQUIBASE_COMMAND_CHANGELOG_FILE=changelog.xml memoon-liquibase update

      - name: Type check
        run: yarn type-check

      - name: Lint
        run: yarn lint

      - name: Unit tests (backend)
        run: yarn test:backend

      - name: Unit tests (frontend)
        run: yarn test:frontend

  e2e:
    runs-on: ubuntu-latest
    env:
      CI: true
      NODE_ENV: development
      FRONTEND_PORT: "3002"
      BACKEND_PORT: "4002"
      POSTGRES_PORT: "5433"
      PLAYWRIGHT_BASE_URL: http://localhost:3002
      E2E_TEST_PASSWORD: TestPassword123!
      E2E_TEST_EMAIL: e2e@test.local
      JWT_SECRET: ci-secret-minimum-32-characters-long
      POSTGRES_DB: memoon_card_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_HOST_DOCKER: postgres
      POSTGRES_PORT_DOCKER: "5432"
      BACKEND_URL_DOCKER: http://memoon-card-backend:4002
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"

      - name: Enable Corepack and Yarn
        run: corepack enable && corepack prepare yarn@4.12.0 --activate

      - name: Install dependencies
        run: yarn install --immutable

      - name: Install Playwright browsers
        run: yarn test:e2e:install

      - name: Build Liquibase image
        run: docker build -f migrations/Dockerfile.liquibase -t memoon-liquibase migrations

      - name: Start Docker stack
        run: yarn docker:up

      - name: Run database migrations
        run: yarn migrate:docker

      - name: Wait for backend health
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:4002/health >/dev/null; then
              echo "Backend is healthy"
              exit 0
            fi
            sleep 2
          done
          echo "Backend health check timed out"
          docker compose logs --tail=200 backend
          exit 1

      - name: Wait for frontend
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:3002/en >/dev/null; then
              echo "Frontend is up"
              exit 0
            fi
            sleep 2
          done
          echo "Frontend check timed out"
          docker compose logs --tail=200 frontend
          exit 1

      - name: Run E2E smoke tests
        run: yarn test:e2e

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report
          if-no-files-found: ignore

      - name: Upload Playwright test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: frontend/test-results
          if-no-files-found: ignore

      - name: Docker logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --tail=300 backend frontend postgres

      - name: Shutdown Docker stack
        if: always()
        run: yarn docker:down
